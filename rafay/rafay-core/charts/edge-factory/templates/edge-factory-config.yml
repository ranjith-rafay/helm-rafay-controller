---
apiVersion: v1
kind: ConfigMap
metadata:
  name: edgefactory-cm
data:
  rafay-kube-system-psp-role-binding.yaml: |-
    {{- if (semverCompare ">=1.21.0-0" .Capabilities.KubeVersion.Version) }}
    apiVersion: policy/v1
    {{- else }}
    apiVersion: policy/v1beta1
    {{- end }}
    kind: PodSecurityPolicy
    metadata:
      name: rafay-kube-system-psp
      annotations:
        seccomp.security.alpha.kubernetes.io/allowedProfileNames: "*"
    spec:
      privileged: true
      allowPrivilegeEscalation: true
      allowedCapabilities:
        - "*"
      volumes:
        - "*"
      hostNetwork: true
      hostPorts:
        - min: 0
          max: 65535
      hostIPC: true
      hostPID: true
      runAsUser:
        rule: "RunAsAny"
      seLinux:
        rule: "RunAsAny"
      supplementalGroups:
        rule: "RunAsAny"
      fsGroup:
        rule: "RunAsAny"
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: rafay:kube-system-psp:cluster-role
      labels:
        kubernetes.io/cluster-service: "true"
        eks.amazonaws.com/component: pod-security-policy
    rules:
      - apiGroups:
          - policy
        resourceNames:
          - rafay-kube-system-psp
        resources:
          - podsecuritypolicies
        verbs:
          - use
    ---
    kind: RoleBinding
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
      name: rafay:kube-system-psp:role-binding
      namespace: kube-system
    roleRef:
      kind: ClusterRole
      name: rafay:kube-system-psp:cluster-role
      apiGroup: rbac.authorization.k8s.io
    subjects:
    - kind: Group
      name: system:serviceaccounts:kube-system
      apiGroup: rbac.authorization.k8s.io
    - kind: Group
      apiGroup: rbac.authorization.k8s.io
      name: system:nodes
    - kind: User
      apiGroup: rbac.authorization.k8s.io
      name: kubelet
