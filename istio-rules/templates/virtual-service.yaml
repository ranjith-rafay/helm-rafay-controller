apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: scheduler-api-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - api.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5002
  - match:
    - uri:
        prefix: /environment/v1
    route:
    - destination:
        host: eaas-api.rafay-core.svc.cluster.local
        port:
          number: 6002
  - match:
    - uri:
        prefix: /approval/v1
    route:
    - destination:
        host: approvals.rafay-core.svc.cluster.local
        port:
          number: 9001
  - match:
    - uri:
        prefix: /e2e/engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5003    
  - match:
    - uri:
        prefix: /v2/scheduler
    - uri:
        prefix: /v2/cluster          
    route:
    - destination:
        host: scheduler.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/config
    route:
    - destination:
        host: rafay-config.rafay-core.svc.cluster.local
        port:
          number: 9000
  - match:
    - uri:
        prefix: /v2/pipeline
    route:
    - destination:
        host: rafay-pipeline.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /swagger-ui
    route:
    - destination:
        host: rafay-swagger.rafay-core.svc.cluster.local
        port:
          number: 8080
  - match:
    - uri:
        prefix: /apis
    route:
    - destination:
        host: rafay-hub.rafay-core.svc.cluster.local
        port:
          number: 7001
  - match:
    - uri:
        prefix: /capability/v1
    route:
    - destination:
        host: capability-api.rafay-core.svc.cluster.local
        port:
          number: 5001
  - match:
    - uri:
        prefix: /openapi-explorer
    route:
    - destination:
        host: rafay-hub.rafay-core.svc.cluster.local
        port:
          number: 7001
  - match:
    - uri:
        prefix: /v2/prompt/debug
    route:
    - destination:
        host: rafay-prompt.rafay-core.svc.cluster.local
        port:
          number: 8000
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: scheduler-controller-ingress-vs
spec:
  gateways:
  - edgecomm-gw
  hosts:
  - control.core.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - control.core.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: scheduler.rafay-core.svc.cluster.local
        port:
          number: 5002
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: opsconsole-ingress-vs
spec:
  hosts:
  - ops-console.{{.Values.global.default_partner_console_domain}}
  gateways:
  - admin-ingress-gw
  http:
  - match:
    - headers:
        user-agent:
          prefix: docker
    route:
    - destination:
        {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        port:
          {{- if and .Values.global.default_partner_console_cert  .Values.global.default_partner_console_key }}
          number: 444        
          {{- else}}
          number: 443    
          {{- end }}      
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        port:
          number: 5000        
        {{- end }}
  - match:
    - uri:
        prefix: /repository
    - uri:
        prefix: /service
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 8081
  - match:
    - uri:
        prefix: /rafay/repository
    rewrite:
      uri: /repository
    route:
    - destination:
        host: nexus-service.rafay-registry.svc.cluster.local
        port:
          number: 8081          
  - match:
    - uri:
        prefix: /auth/v1
    - uri:
        prefix: /config/v1
    - uri:
        prefix: /config/v2
    route:
    - destination:
        host: admin-api.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /edge/v1
    route:
    - destination:
        host: edgesrv.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /placement/v1
    route:
    - destination:
        host: workload-placement.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /event/v1
    route:
    - destination:
        host: event-framework.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /cls/v1
    route:
    - destination:
        host: edge-processor.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/config
    route:
    - destination:
        host: rafay-config.rafay-core.svc.cluster.local
        port:
          number: 9000
  - match:
    - uri:
        prefix: /v2/cluster
    - uri:
        prefix: /v2/scheduler
    route:
    - destination:
        host: scheduler.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/sentry
    route:
    - destination:
        host: rafay-sentry.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/debug
    route:
    - destination:
        host: rafay-prompt.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /jaeger
    route:
    - destination:
        host: tracing.istio-system.svc.cluster.local
        port:
          number: 80
  - match:
    - uri:
        prefix: /repository
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 8081
  - match:
    - uri:
        prefix: /v2/pipeline
    route:
    - destination:
        host: rafay-pipeline.rafay-core.svc.cluster.local
        port:
          number: 8000          
  - match:
    - uri:
        prefix: /v2
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        port:
          {{- if and .Values.global.default_partner_console_cert  .Values.global.default_partner_console_key }}
          number: 444        
          {{- else}}
          number: 443    
          {{- end }}         
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        port:
          number: 5000        
        {{- end }}

  {{- if .Values.global.monitoring.integrations.amp.enabled}}
  - match:
    - uri:
        prefix: /tsdb/write
    rewrite:
      uri: {{ printf "/workspaces/%s/api/v1/remote_write" .Values.global.monitoring.integrations.amp.workspaceId }}   
    route:
    - destination:
        host: sigv4-proxy-relay.rafay-core.svc.cluster.local
        port:
          number: 8005
  {{- else }}      
  - match:
    - uri:
        prefix: /tsdb/write
    rewrite:
      uri: /write
    route:
    - destination:
        host: promscale-connector.rafay-core.svc.cluster.local
        port:
          number: 9201
  {{- end}}
  - match:
    - uri:
        prefix: /app/
    - uri:
        prefix: /bundles/
    - uri:
        prefix: /ui
    - uri:
        prefix: /built_assets/
    - uri:
        prefix: /api
    - uri:
        prefix: /translations/
    - uri:
        prefix: /plugins/
    - uri:
        prefix: /elasticsearch/
    route:
    - destination:
        host: rafay-core-kibana.rafay-core.svc.cluster.local
        port:
          number: 5601
  - match:
    - uri:
        prefix: /capability/v1
    route:
    - destination:
        host: capability-api.rafay-core.svc.cluster.local
        port:
          number: 5001
  - match:
    - uri:
        prefix: /swagger-ui
    route:
    - destination:
        host: rafay-swagger.rafay-core.svc.cluster.local
        port:
          number: 8080
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend-opsconsole.rafay-core.svc.cluster.local
        port:
          number: 8081
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: console-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - console.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /auth/v1/groups
    route:
    - destination:
        host: rafay-sentry.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /auth/v1
    - uri:
        prefix: /config/v1
    - uri:
        prefix: /config/v2
    - uri:
        prefix: /data/v1
    - uri:
        prefix: /v1/auth
    - uri:
        prefix: /v1/config
    route:
    - destination:
        host: admin-api.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match: 
    - uri:
        prefix: /v1/infraController
    route:
    - destination:
        host: capi-controller-vsphere.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /edge/v1
    - uri:
        prefix: /v1/infra
    route:
    - destination:
        host: edgesrv.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /placement/v1
    route:
    - destination:
        host: workload-placement.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /event/v1
    route:
    - destination:
        host: event-framework.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /capability/v1
    route:
    - destination:
        host: capability-api.rafay-core.svc.cluster.local
        port:
          number: 5001
  - match:
    - uri:
        prefix: /cls/v1
    route:
    - destination:
        host: edge-processor.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /kiali
    route:
    - destination:
        host: rafay-kiali.rafay-core.svc.cluster.local
        port:
          number: 20001
  - match:
    - uri:
        prefix: /debug
    route:
    - destination:
        host: debug-processor.rafay-core.svc.cluster.local
        port:
          number: 40001
  - match:
    - uri:
        prefix: /v2/config
    route:
    - destination:
        host: rafay-config.rafay-core.svc.cluster.local
        port:
          number: 9000
  - match:
    - uri:
        prefix: /v2/cluster
    - uri:
        prefix: /v2/scheduler
    route:
    - destination:
        host: scheduler.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /repository
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 8081
  - match:
    - uri:
        prefix: /v2/debug
    route:
    - destination:
        host: rafay-prompt.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/sentry
    route:
    - destination:
        host: rafay-sentry.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
       prefix: /conjurer
    rewrite:
      uri: /
    route:
    - destination:
        host: rafay-core-rafay-assets.rafay-core.svc.cluster.local 
        port:
          number: 80
  - match:
    - uri:
       prefix: /cli
    rewrite:
      uri: /
    route:
    - destination:
        host: rafay-core-rafay-assets.rafay-core.svc.cluster.local
        port:
          number: 80
  - match:
    - uri:
        prefix: /v2/pipeline
    route:
    - destination:
        host: rafay-pipeline.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /swagger-ui
    route:
    - destination:
        host: rafay-swagger.rafay-core.svc.cluster.local
        port:
          number: 8080
  - match:
    - uri:
        prefix: /v2/infraProvisioner
    route:
    - destination:
        host: infra-provisioner.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /v2/infra
    route:
    - destination:
        host: infra-apiserver.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /clusterconfig/v1/
    route:
    - destination:
        host: cluster-config.rafay-core.svc.cluster.local
        port:
          number: 8000
  - match:
    - uri:
        prefix: /apis
    route:
    - destination:
        host: rafay-hub.rafay-core.svc.cluster.local
        port:
          number: 7001
  - match:
    - uri:
        prefix: /engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5002
  - match:
    - uri:
        prefix: /environment/v1
    route:
    - destination:
        host: eaas-api.rafay-core.svc.cluster.local
        port:
          number: 6002
  - match:
    - uri:
        prefix: /approval/v1
    route:
    - destination:
        host: approvals.rafay-core.svc.cluster.local
        port:
          number: 9001
  - match:
    - uri:
        prefix: /openapi-explorer
    route:
    - destination:
        host: rafay-hub.rafay-core.svc.cluster.local
        port:
          number: 7001
  - match:
    - uri:
        prefix: /e2e/engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5003
{{- if eq .Values.global.disable_xframe_Cors_policy true }}
    headers:
      response:
        remove:
        - x-frame-options
        - content-security-policy
    corsPolicy:
      allowOrigins:
        - exact: "*"
      allowMethods:
        - POST
        - GET
        - PUT
        - DELETE
        - OPTIONS
      allowHeaders:
        - "*"
{{- end }}
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend.rafay-core.svc.cluster.local
        port:
          number: 8081      
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: user-relay-ingress-vs
  namespace: istio-system
spec:
  gateways:
  - user-relay
  hosts:
  - '*.user.core.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.user.core.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: registry-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - registry.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 5000
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kiali-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - kiali.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: kiali.istio-system.svc.cluster.local
        port:
          number: 20001
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: grafana-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - grafana.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: grafana.istio-system.svc.cluster.local
        port:
          number: 3000
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: jaeger-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - tracing.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: tracing.istio-system.svc.cluster.local
        port:
          number: 80
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kibana-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - kibana.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: rafay-kibana-kb-http.rafay-core.svc.cluster.local
        port:
          number: 5601
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: cryptosvc-vs
spec:
  gateways:
  - edgecomm-gw
  hosts:
  - cryptosvc.core.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - cryptosvc.core.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: cryptosvc.rafay-core.svc.cluster.local
        port:
          number: 50506
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: edge-vs
spec:
  gateways:
  - edgecomm-gw
  hosts:
  - edge.core.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - edge.core.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: edge-broker.rafay-core.svc.cluster.local
        port:
          number: 5448
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: event-vs
spec:
  gateways:
  - edgecomm-gw
  hosts:
  - event.core.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - event.core.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: event-framework.rafay-core.svc.cluster.local
        port:
          number: 7001
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: fluentd-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - fluentd-aggr.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: fluentd-aggregator.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: repo-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - repo.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 8081
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nexus-ingress-vs
spec:
  gateways:
  - nexus-ingress-gw
  hosts:
  - salt.core.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /repository
    route:
    - destination:
         {{- if eq .Values.global.isCustomRegistry true}} 
        host: nexus-service.rafay-registry.svc.cluster.local
        {{- else }}
        host: nexus-service.rafay-core.svc.cluster.local
        {{- end }}
        port:
          number: 8081
  - match:
    - uri:
        prefix: /v2
    route:
    - destination:
        host: registry.rafay-core.svc.cluster.local
        port:
          number: 5000
  # - match:
  #   - uri:
  #       prefix: /
  #   route:
  #   - destination:
  #       host: infra-salt-orchestrator.rafay-core.svc.cluster.local
  #       port:
  #         number: 443
  # - match:
  #   - headers:
  #       target-host:
  #         exact: infra-salt-orchestrator-0
  #   route:
  #   - destination:
  #       host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
  #       port:
  #         number: 443
  #       subset: s0
  # - match:
  #   - headers:
  #       target-host:
  #         exact: infra-salt-orchestrator-1
  #   route:
  #   - destination:
  #       host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
  #       port:
  #         number: 443
  #       subset: s1       
  # - match:
  #   - uri:
  #       prefix: /
  #   route:
  #   - destination:
  #       host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
  #       port:
  #         number: 443
  #       subset: s0
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: chisel-http-ingress-vs
  namespace: istio-system
spec:
  gateways:
  - nexus-ingress-gw
  hosts:
  - salt.core.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - headers:
        target-host:
          exact: infra-salt-orchestrator-0
    route:
    - destination:
        host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
        port:
          number: 443
        subset: s0
  - match:
    - headers:
        target-host:
          exact: infra-salt-orchestrator-1
    route:
    - destination:
        host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
        port:
          number: 443
        subset: s1
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: infra-salt-orchestrator-ext.rafay-core.svc.cluster.local
        port:
          number: 443
        subset: s0
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rcr-vs
spec:
  gateways:
  - rcr-gw
  hosts:
  - rcr.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - rcr.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: rafay-container-registry.rafay-core.svc.cluster.local
        port:
          number: 6000
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: regauth-vs
spec:
  gateways:
  - regauth-gw
  hosts:
  - regauth.{{.Values.global.default_partner_console_domain}}
  tls:
  - match:
    - port: 443
      sniHosts:
      - regauth.{{.Values.global.default_partner_console_domain}}
    route:
    - destination:
        host: regauth.rafay-core.svc.cluster.local
        port:
          number: 5001
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: prometheus-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - prometheus.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: prometheus.istio-system.svc.cluster.local
        port:
          number: 9090
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: core-connector-ingress-vs
spec:
  gateways:
  - core-connector-gw
  hosts:
  - '*.core-connector.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.core-connector.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: core-connector-kubeapi-vs
spec:
  gateways:
  - core-connector-kubeapi-gw
  hosts:
  - '*.connector.kubeapi-proxy.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.connector.kubeapi-proxy.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: user-relay-kubeapi-vs
spec:
  gateways:
  - user-relay-kubeapi-gw
  hosts:
  - '*.user.kubeapi-proxy.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.user.kubeapi-proxy.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: user-relay-vs
spec:
  gateways:
  - user-relay-gw
  hosts:
  - '*.user.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.user.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: core-connector-cdrelay-ingress-vs
spec:
  gateways:
  - core-connector-cdrelay-gw
  hosts:
  - '*.connector.cdrelay.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.connector.cdrelay.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-cd-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: user-cdrelay-ingress-vs
spec:
  gateways:
  - user-cdrelay-gw
  hosts:
  - '*.user.cdrelay.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.user.cdrelay.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-cd-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: peering-vs
spec:
  gateways:
  - peering-gw
  hosts:
  - 'peering.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - 'peering.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: rafay-sentry.rafay-core.svc.cluster.local
        port:
          number: 7001
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-infrarelay-ingress-vs
spec:
  gateways:
  - user-infrarelay-gw
  hosts:
  - '*.user.infrarelay.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.user.infrarelay.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: infra-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: core-connector-infrarelay-ingress-vs
spec:
  gateways:
  - core-connector-infrarelay-gw
  hosts:
  - '*.connector.infrarelay.{{.Values.global.default_partner_console_domain}}'
  tls:
  - match:
    - port: 443
      sniHosts:
      - '*.connector.infrarelay.{{.Values.global.default_partner_console_domain}}'
    route:
    - destination:
        host: infra-relay.rafay-core.svc.cluster.local
        port:
          number: 443
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: envmgr-vs
  namespace: istio-system
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - 'api.{{.Values.global.default_partner_console_domain}}'
  - 'console.{{.Values.global.default_partner_console_domain}}'
  http:
  - match:
    - uri:
        prefix: /engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5002
  - match:
    - uri:
        prefix: /environment/v1
    - uri:
      prefix: /environment-utility/v1
    route:
    - destination:
        host: eaas-api.rafay-core.svc.cluster.local
        port:
          number: 6002
  - match:
    - uri:
        prefix: /approval/v1
    route:
    - destination:
        host: approvals.rafay-core.svc.cluster.local
        port:
          number: 9001
  - match:
    - uri:
        prefix: /e2e/engine/v1
    route:
    - destination:
        host: engine-api.rafay-core.svc.cluster.local
        port:
          number: 5003 
  - match:
    - uri:
        prefix: /auth/v1/groups
    route:
    - destination:
        host: rafay-sentry.rafay-core.svc.cluster.local
        port:
          number: 8000         
---          
{{- if .Values.global.external_metrics.enabled }}  
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rafay-prometheus-ingress-vs
spec:
  gateways:
  - admin-ingress-gw
  hosts:
  - rafay-prometheus.{{.Values.global.default_partner_console_domain}}
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: rafay-core-kube-prometheus-prometheus.rafay-core.svc.cluster.local
        port:
          number: 9090
{{- end }}
